<?php/***********************Makes use of two MySQL tables.users:CREATE TABLE `users` (  `id` int(11) NOT NULL auto_increment,  `username` varchar(20) default NULL,  `password` varchar(40) default NULL,  `fullname` varchar(30) default NULL,  PRIMARY KEY  (`id`)) TYPE=MyISAMseeds:CREATE TABLE `seeds` (  `ID` int(11) NOT NULL auto_increment,  `Seed` timestamp(14) NOT NULL,  PRIMARY KEY  (`ID`)) TYPE=MyISAM*/$gTask = "";$gUsername = "";$gHash = "";$gSeedId = "";$con;getInput();doTask();function getInput(){	global $gTask;	global $gUsername;	global $gSeedId;	global $gHash;	$gTask=$_GET["t"];	$gUsername=$_GET["u"];	$gSeedId=$_GET["sid"];	$gHash=$_GET["h"];}function openDBConnection(){	global $con;	$con = mysql_connect("localhost","davean8_johng","win32api");	if (!$con)	{		die('Could not connect: ' . mysql_error());	}	mysql_select_db("davean8_Bible", $con);}function closeDBConnection(){	global $con;	mysql_close($con);}function doTask(){	global $gTask;		openDBConnection();	if ($gTask == "getseed")	{		doGetSeed();	}	else if ($gTask == "checklogin")	{		doCheckLogin();	}	closeDBConnection();}function doGetSeed(){	mysql_query('INSERT INTO Seeds VALUES()'); // insert a new row with default values	// get the values from the row back	$result = mysql_query('SELECT ID, Seed FROM Seeds ORDER BY ID DESC LIMIT 1');	if (!$result) 	{		echo "false|" . mysql_error();		return false;	}	$row = mysql_fetch_assoc($result); // only one row so take the first row	echo($row['ID'].'|'.$row['Seed']);  // write back the data in form id|random_value} //doGetSeed()function doCheckLogin(){	global $gUsername;	global $gPassword;	global $gHash;	global $gSeedId;		$lastBookID = 1;	$lastChapterNumber = 1;	$lastVerseNumber = 1;		// formulate query for username		$sql = 'SELECT * FROM Users WHERE UserName = \'' . mysql_real_escape_string($gUsername) . '\'';	$result = mysql_query($sql);		// fail on sql failure	if (!$result)  	{		echo "false|Could not connect to login database.  Please try again";		return false;	}		// get the first user with username in the table (should only be one)	$user_row = mysql_fetch_assoc($result);	// if there isn't one	if (!$user_row)	{		echo "false|Invalid username and password combination.";		return false;	}		// formulate query for random timestamp for given id	$sql = 'SELECT * FROM Seeds WHERE ID=' . (int)$gSeedId;	$result =  mysql_query($sql);	// die if no value for given id	if (!$result) 	{		echo "false|Unknown error (hacking attempt).";		return false;	}		///////////////////////////////////////////////////	// get the first (only) seed	$seed_row = mysql_fetch_assoc($result);		// fail if no row	if (!$seed_row) 	{		echo "false|Unknown error (hacking attempt).";		return false;	}		// if the md5 hashes are equal to those generated by the clientside js	$md5str = md5(md5($user_row['Password']) . $seed_row['Seed']);	if ($md5str == $gHash) 	{		if ($user_row['LastBookID'] != null)		{			$lastBookID = $user_row['LastBookID'];			if ($user_row['LastChapterNumber'] != null)			{				$lastChapterNumber = $user_row['LastChapterNumber'];				if ($user_row['LastVerseNumber'] != null)					$lastVerseNumber = $user_row['LastVerseNumber'];			}		}		// logged in		echo('true|' .  $user_row['FirstName'] . " " . $user_row['MiddleInitial'] . " " . $user_row['LastName'] . "|" . $lastBookID . "|" . $lastChapterNumber . "|" . $lastVerseNumber);		// now remove the random key that was made for this request		mysql_query('DELETE FROM Seed WHERE ID=' . (int)$gSeedId);		return true;	}	else	{		// not logged in.. incorrect password		echo "false|Invalid username and password combination.";		return false;	}} //doCheckLogin()?>